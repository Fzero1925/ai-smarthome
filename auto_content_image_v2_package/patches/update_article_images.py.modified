#!/usr/bin/env python3
"""
ğŸ“„ æ–‡ç« å›¾ç‰‡é…ç½®æ›´æ–°å·¥å…·
æ‰¹é‡æ›´æ–°æ‰€æœ‰æ–‡ç« çš„featured_imageé…ç½®ï¼Œè§£å†³AdSenseå›¾ç‰‡è¦æ±‚

åŠŸèƒ½ï¼š
- è‡ªåŠ¨åˆ†ææ–‡ç« å…³é”®è¯å’Œåˆ†ç±»
- æ™ºèƒ½åŒ¹é…äº§å“å›¾ç‰‡æ•°æ®åº“
- æ‰¹é‡æ›´æ–°featured_imageé…ç½®
- æ·»åŠ SEOä¼˜åŒ–çš„Altæ ‡ç­¾

ä½œè€…ï¼šSmart Home Research Team
ç‰ˆæœ¬ï¼š1.0.0
æ—¥æœŸï¼š2025-09-09
"""

import os
import sys
import json
import re
from pathlib import Path
from typing import Dict, List, Optional, Tuple
from datetime import datetime
import codecs
import random

# è§£å†³Windowsç¼–ç é—®é¢˜
if sys.platform == "win32":
    try:
        sys.stdout = codecs.getwriter("utf-8")(sys.stdout.detach())
        sys.stderr = codecs.getwriter("utf-8")(sys.stderr.detach())
    except Exception:
        pass

class ArticleImageUpdater:
    """æ–‡ç« å›¾ç‰‡é…ç½®æ›´æ–°å™¨"""
    
    def __init__(self, articles_dir: str = "content/articles"):
        self.articles_dir = Path(articles_dir)
        self.data_dir = Path("data")
        self.data_dir.mkdir(exist_ok=True)
        
        # å®Œæ•´çš„äº§å“å›¾ç‰‡æ˜ å°„æ•°æ®åº“
        self.image_database = {
            'smart-plugs': [
                {'path': '/images/products/smart-plugs/amazon-smart-plug-hero.jpg', 'alt': 'Amazon Smart Plug - Best Alexa compatible smart outlet 2025', 'title': 'Amazon Smart Plug'},
                {'path': '/images/products/smart-plugs/amazon-smart-plug-main.jpg', 'alt': 'Smart plug with energy monitoring - Alexa WiFi outlet', 'title': 'Alexa Smart Plug'},
                {'path': '/images/products/smart-plugs/govee-wifi-smart-plug.jpg', 'alt': 'Govee WiFi Smart Plug - Voice control outlet with app', 'title': 'Govee Smart Plug'},
                {'path': '/images/products/smart-plugs/tp-link-kasa-hs103.jpg', 'alt': 'TP-Link Kasa Smart Plug - Reliable WiFi outlet for home automation', 'title': 'TP-Link Kasa HS103'},
                {'path': '/images/products/smart-plugs/smart-plug-comparison-2025.jpg', 'alt': 'Smart plug comparison guide 2025 - Best WiFi outlets reviewed', 'title': 'Smart Plug Comparison 2025'}
            ],
            'smart-thermostats': [
                {'path': '/images/products/smart-thermostats/nest-learning-thermostat.jpg', 'alt': 'Google Nest Learning Thermostat - Smart climate control 2025', 'title': 'Nest Learning Thermostat'},
                {'path': '/images/products/smart-thermostats/ecobee-smartthermostat.jpg', 'alt': 'Ecobee SmartThermostat with voice control - Energy saving', 'title': 'Ecobee SmartThermostat'},
                {'path': '/images/products/smart-thermostats/honeywell-t9.jpg', 'alt': 'Honeywell T9 Smart Thermostat - WiFi programmable thermostat', 'title': 'Honeywell T9'},
                {'path': '/images/products/smart-thermostats/thermostat-installation.jpg', 'alt': 'Smart thermostat installation guide - Professional setup', 'title': 'Smart Thermostat Installation'},
                {'path': '/images/products/smart-thermostats/energy-savings-comparison.jpg', 'alt': 'Smart thermostat energy savings comparison - Cost analysis 2025', 'title': 'Energy Savings Analysis'}
            ],
            'security-cameras': [
                {'path': '/images/products/security-cameras/arlo-pro-4.jpg', 'alt': 'Arlo Pro 4 Security Camera - Wireless home surveillance', 'title': 'Arlo Pro 4'},
                {'path': '/images/products/security-cameras/ring-spotlight-cam.jpg', 'alt': 'Ring Spotlight Cam - Motion detection security camera', 'title': 'Ring Spotlight Cam'},
                {'path': '/images/products/security-cameras/wyze-cam-v3.jpg', 'alt': 'Wyze Cam v3 - Affordable smart security camera with night vision', 'title': 'Wyze Cam v3'},
                {'path': '/images/products/security-cameras/security-system-setup.jpg', 'alt': 'Complete home security camera system setup guide', 'title': 'Security System Setup'},
                {'path': '/images/products/security-cameras/outdoor-camera-features.jpg', 'alt': 'Outdoor security camera features comparison - Weather resistant', 'title': 'Outdoor Camera Features'}
            ],
            'robot-vacuums': [
                {'path': '/images/products/robot-vacuums/roomba-i7.jpg', 'alt': 'iRobot Roomba i7+ - Self-emptying robot vacuum 2025', 'title': 'Roomba i7+'},
                {'path': '/images/products/robot-vacuums/roborock-s7.jpg', 'alt': 'Roborock S7 - Mopping robot vacuum with sonic technology', 'title': 'Roborock S7'},
                {'path': '/images/products/robot-vacuums/shark-iq.jpg', 'alt': 'Shark IQ Robot Vacuum - Self-emptying with mapping', 'title': 'Shark IQ Robot'},
                {'path': '/images/products/robot-vacuums/vacuum-comparison.jpg', 'alt': 'Robot vacuum comparison 2025 - Features and performance', 'title': 'Robot Vacuum Comparison'},
                {'path': '/images/products/robot-vacuums/cleaning-patterns.jpg', 'alt': 'Robot vacuum cleaning patterns - Navigation technology explained', 'title': 'Cleaning Patterns Guide'}
            ],
            'smart-bulbs': [
                {'path': '/images/products/smart-bulbs/philips-hue-color.jpg', 'alt': 'Philips Hue Color Bulbs - RGB smart lighting system', 'title': 'Philips Hue Color'},
                {'path': '/images/products/smart-bulbs/wyze-color-bulb.jpg', 'alt': 'Wyze Color Bulb - Affordable smart LED with color changing', 'title': 'Wyze Color Bulb'},
                {'path': '/images/products/smart-bulbs/lifx-color.jpg', 'alt': 'LIFX Color Smart Bulb - Vibrant WiFi LED lighting', 'title': 'LIFX Color'},
                {'path': '/images/products/smart-bulbs/smart-lighting-setup.jpg', 'alt': 'Smart lighting setup guide - Creating perfect ambiance', 'title': 'Smart Lighting Setup'},
                {'path': '/images/products/smart-bulbs/color-temperature-guide.jpg', 'alt': 'Smart bulb color temperature guide - Warm to cool lighting', 'title': 'Color Temperature Guide'}
            ],
            'smart-speakers': [
                {'path': '/images/products/smart-speakers/echo-dot-5.jpg', 'alt': 'Amazon Echo Dot 5th Gen - Compact smart speaker with Alexa', 'title': 'Echo Dot 5th Gen'},
                {'path': '/images/products/smart-speakers/google-nest-mini.jpg', 'alt': 'Google Nest Mini - Small smart speaker with Assistant', 'title': 'Google Nest Mini'},
                {'path': '/images/products/smart-speakers/homepod-mini.jpg', 'alt': 'Apple HomePod Mini - Premium compact smart speaker', 'title': 'HomePod Mini'},
                {'path': '/images/products/smart-speakers/speaker-comparison.jpg', 'alt': 'Smart speaker comparison 2025 - Features and sound quality', 'title': 'Smart Speaker Comparison'},
                {'path': '/images/products/smart-speakers/voice-assistant-setup.jpg', 'alt': 'Voice assistant setup guide - Optimizing smart speaker', 'title': 'Voice Assistant Setup'}
            ],
            'smart-lighting': [
                {'path': '/images/products/smart-lighting/hue-lightstrip.jpg', 'alt': 'Philips Hue Lightstrip Plus - Flexible smart LED strips', 'title': 'Hue Lightstrip Plus'},
                {'path': '/images/products/smart-lighting/lutron-caseta.jpg', 'alt': 'Lutron Caseta Smart Switch - Professional grade lighting control', 'title': 'Lutron Caseta'},
                {'path': '/images/products/smart-lighting/kasa-smart-switch.jpg', 'alt': 'Kasa Smart WiFi Switch - Easy installation lighting control', 'title': 'Kasa Smart Switch'},
                {'path': '/images/products/smart-lighting/lighting-scenes.jpg', 'alt': 'Smart lighting scenes setup - Mood and ambiance control', 'title': 'Smart Lighting Scenes'},
                {'path': '/images/products/smart-lighting/dimmer-installation.jpg', 'alt': 'Smart dimmer installation guide - Step by step setup', 'title': 'Smart Dimmer Installation'}
            ]
        }
        
        # å…³é”®è¯åˆ°åˆ†ç±»çš„æ˜ å°„
        self.keyword_to_category = {
            'smart plug': 'smart-plugs',
            'wifi outlet': 'smart-plugs', 
            'alexa plug': 'smart-plugs',
            'smart outlet': 'smart-plugs',
            'thermostat': 'smart-thermostats',
            'climate control': 'smart-thermostats',
            'temperature': 'smart-thermostats',
            'heating': 'smart-thermostats',
            'security camera': 'security-cameras',
            'surveillance': 'security-cameras',
            'home camera': 'security-cameras',
            'wireless camera': 'security-cameras',
            'robot vacuum': 'robot-vacuums',
            'vacuum cleaner': 'robot-vacuums',
            'robotic vacuum': 'robot-vacuums',
            'smart bulb': 'smart-bulbs',
            'led bulb': 'smart-bulbs',
            'smart light': 'smart-bulbs',
            'color bulb': 'smart-bulbs',
            'smart speaker': 'smart-speakers',
            'echo': 'smart-speakers',
            'alexa': 'smart-speakers',
            'google home': 'smart-speakers',
            'smart lighting': 'smart-lighting',
            'light switch': 'smart-lighting',
            'smart switch': 'smart-lighting',
            'lighting control': 'smart-lighting'
        }
    
    def analyze_article(self, article_path: Path) -> Dict:
        """åˆ†ææ–‡ç« å†…å®¹å¹¶ç¡®å®šåˆ†ç±»"""
        try:
            content = article_path.read_text(encoding='utf-8')
            
            # æå–front matter
            if not content.startswith('---'):
                return {'error': 'Invalid article format'}
            
            lines = content.split('\n')
            front_matter = {}
            content_start = 1
            
            for i, line in enumerate(lines[1:], 1):
                if line.strip() == '---':
                    content_start = i + 1
                    break
                    
                if ':' in line:
                    key, value = line.split(':', 1)
                    key = key.strip()
                    value = value.strip().strip('"').strip("'")
                    
                    # å¤„ç†åˆ—è¡¨æ ¼å¼
                    if value.startswith('[') and value.endswith(']'):
                        value = [item.strip().strip('"').strip("'") for item in value[1:-1].split(',')]
                    
                    front_matter[key] = value
            
            # åˆ†æå†…å®¹ç¡®å®šåˆ†ç±»
            title = front_matter.get('title', '')
            keywords = front_matter.get('keywords', [])
            categories = front_matter.get('categories', [])
            
            # åˆå¹¶æ‰€æœ‰æ–‡æœ¬ç”¨äºåˆ†æ
            analysis_text = f"{title} {' '.join(keywords) if isinstance(keywords, list) else keywords} {' '.join(categories) if isinstance(categories, list) else categories}".lower()
            
            # ç¡®å®šæœ€ä½³åˆ†ç±»
            category_scores = {}
            for keyword, category in self.keyword_to_category.items():
                if keyword in analysis_text:
                    category_scores[category] = category_scores.get(category, 0) + 1
            
            # é€‰æ‹©å¾—åˆ†æœ€é«˜çš„åˆ†ç±»
            best_category = 'smart-plugs'  # é»˜è®¤åˆ†ç±»
            if category_scores:
                best_category = max(category_scores.items(), key=lambda x: x[1])[0]
            
            return {
                'title': title,
                'keywords': keywords,
                'categories': categories,
                'front_matter': front_matter,
                'best_category': best_category,
                'content_start': content_start,
                'full_content': content
            }
            
        except Exception as e:
            return {'error': f'Failed to analyze article: {e}'}
    
    def select_best_image(self, category: str, article_title: str) -> Dict:
        """ä¸ºæ–‡ç« é€‰æ‹©æœ€ä½³å›¾ç‰‡"""
        if category not in self.image_database:
            category = 'smart-plugs'  # é»˜è®¤åˆ†ç±»
        
        images = self.image_database[category]
        
        # åŸºäºæ–‡ç« æ ‡é¢˜æ™ºèƒ½é€‰æ‹©
        title_lower = article_title.lower()
        
        # ä¼˜å…ˆé€‰æ‹©ä¸æ ‡é¢˜åŒ¹é…çš„å›¾ç‰‡
        for image in images:
            image_title_lower = image['title'].lower()
            if any(word in image_title_lower for word in title_lower.split() if len(word) > 3):
                return image
        
        # å¦‚æœæ²¡æœ‰åŒ¹é…çš„ï¼Œé€‰æ‹©ç¬¬ä¸€å¼ ï¼ˆé€šå¸¸æ˜¯ä¸»å›¾ï¼‰
        return images[0] if images else {
            'path': '/images/products/general/default-product.jpg',
            'alt': f'Professional {category.replace("-", " ")} guide 2025',
            'title': 'Smart Home Device'
        }
    
    def update_article_image(self, article_path: Path, force_update: bool = False) -> Dict:
        """æ›´æ–°å•ä¸ªæ–‡ç« çš„å›¾ç‰‡é…ç½®"""
        print(f"ğŸ“ å¤„ç†æ–‡ç« : {article_path.name}")
        
        # åˆ†ææ–‡ç« 
        analysis = self.analyze_article(article_path)
        if 'error' in analysis:
            return {'success': False, 'error': analysis['error']}
        
        # æ£€æŸ¥æ˜¯å¦å·²æœ‰featured_imageé…ç½®
        if not force_update and analysis['front_matter'].get('featured_image'):
            print(f"  â© å·²æœ‰å›¾ç‰‡é…ç½®ï¼Œè·³è¿‡")
            return {'success': True, 'action': 'skipped', 'reason': 'already_has_image'}
        
        # é€‰æ‹©æœ€ä½³å›¾ç‰‡
        best_image = self.select_best_image(analysis['best_category'], analysis['title'])
        
        # æ›´æ–°front matter
        lines = analysis['full_content'].split('\n')
        front_matter_end = analysis['content_start'] - 1
        
        # åœ¨front matterä¸­æ·»åŠ æˆ–æ›´æ–°featured_image
        new_lines = lines[:1]  # ä¿ç•™å¼€å§‹çš„ ---
        
        # æ·»åŠ æ‰€æœ‰ç°æœ‰çš„front matterï¼Œä½†è·³è¿‡featured_image
        for line in lines[1:front_matter_end]:
            if not line.startswith('featured_image:'):
                new_lines.append(line)
        
        # æ·»åŠ æ–°çš„featured_imageé…ç½®
        new_lines.append(f'featured_image: "{best_image["path"]}"')
        
        # æ·»åŠ å‰©ä½™å†…å®¹
        new_lines.extend(lines[front_matter_end:])
        
        # å†™å›æ–‡ä»¶
        try:
            new_content = '\n'.join(new_lines)
            article_path.write_text(new_content, encoding='utf-8')
            
            print(f"  âœ… æ›´æ–°æˆåŠŸ: {best_image['path']}")
            return {
                'success': True,
                'action': 'updated',
                'image_path': best_image['path'],
                'category': analysis['best_category'],
                'title': analysis['title']
            }
            
        except Exception as e:
            print(f"  âŒ æ›´æ–°å¤±è´¥: {e}")
            return {'success': False, 'error': str(e)}
    
    def batch_update_articles(self, force_update: bool = False) -> Dict:
        """æ‰¹é‡æ›´æ–°æ‰€æœ‰æ–‡ç« """
        print("ğŸš€ å¼€å§‹æ‰¹é‡æ›´æ–°æ–‡ç« å›¾ç‰‡é…ç½®...")
        print("=" * 50)
        
        if not self.articles_dir.exists():
            return {'success': False, 'error': f'Articles directory not found: {self.articles_dir}'}
        
        # è·å–æ‰€æœ‰markdownæ–‡ä»¶
        md_files = list(self.articles_dir.glob("*.md"))
        print(f"ğŸ“Š å‘ç° {len(md_files)} ç¯‡æ–‡ç« éœ€è¦å¤„ç†")
        print()
        
        results = []
        stats = {'updated': 0, 'skipped': 0, 'failed': 0}
        
        for article_file in sorted(md_files):
            result = self.update_article_image(article_file, force_update)
            results.append({
                'file': article_file.name,
                **result
            })
            
            if result.get('success'):
                if result.get('action') == 'updated':
                    stats['updated'] += 1
                elif result.get('action') == 'skipped':
                    stats['skipped'] += 1
            else:
                stats['failed'] += 1
        
        # ç»Ÿè®¡ç»“æœ
        print(f"\nğŸ‰ æ‰¹é‡æ›´æ–°å®Œæˆ!")
        print(f"ğŸ“Š å¤„ç†ç»Ÿè®¡:")
        print(f"   - æˆåŠŸæ›´æ–°: {stats['updated']} ç¯‡")
        print(f"   - è·³è¿‡å¤„ç†: {stats['skipped']} ç¯‡") 
        print(f"   - å¤„ç†å¤±è´¥: {stats['failed']} ç¯‡")
        print(f"   - æ€»è®¡å¤„ç†: {len(md_files)} ç¯‡")
        
        # æŒ‰åˆ†ç±»ç»Ÿè®¡
        category_stats = {}
        for result in results:
            if result.get('success') and result.get('category'):
                category = result['category']
                category_stats[category] = category_stats.get(category, 0) + 1
        
        if category_stats:
            print(f"\nğŸ“‚ åˆ†ç±»ç»Ÿè®¡:")
            for category, count in sorted(category_stats.items()):
                print(f"   - {category}: {count} ç¯‡")
        
        return {
            'success': True,
            'stats': stats,
            'category_stats': category_stats,
            'results': results
        }
    
    def generate_report(self, results: Dict) -> str:
        """ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š"""
        report_lines = [
            "# æ–‡ç« å›¾ç‰‡é…ç½®æ›´æ–°æŠ¥å‘Š",
            f"ç”Ÿæˆæ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}",
            "",
            "## æ€»ä½“ç»Ÿè®¡",
            f"- æˆåŠŸæ›´æ–°: {results['stats']['updated']} ç¯‡",
            f"- è·³è¿‡å¤„ç†: {results['stats']['skipped']} ç¯‡",
            f"- å¤„ç†å¤±è´¥: {results['stats']['failed']} ç¯‡",
            "",
            "## åˆ†ç±»åˆ†å¸ƒ"
        ]
        
        for category, count in sorted(results['category_stats'].items()):
            report_lines.append(f"- {category.replace('-', ' ').title()}: {count} ç¯‡")
        
        report_lines.extend([
            "",
            "## è¯¦ç»†ç»“æœ"
        ])
        
        for result in results['results']:
            if result.get('success') and result.get('action') == 'updated':
                report_lines.append(f"- âœ… {result['file']}: {result.get('image_path', 'N/A')}")
            elif result.get('action') == 'skipped':
                report_lines.append(f"- â© {result['file']}: å·²æœ‰å›¾ç‰‡é…ç½®")
            else:
                report_lines.append(f"- âŒ {result['file']}: {result.get('error', 'æœªçŸ¥é”™è¯¯')}")
        
        return '\n'.join(report_lines)

def main():
    """ä¸»å‡½æ•°"""
    print("ğŸ“„ AI Smart Home Hub - æ–‡ç« å›¾ç‰‡é…ç½®æ›´æ–°å·¥å…·")
    print("=" * 55)
    
    updater = ArticleImageUpdater()
    
    # è§£æå‘½ä»¤è¡Œå‚æ•°
    force_update = '--force' in sys.argv
    
    if force_update:
        print("âš ï¸ å¼ºåˆ¶æ›´æ–°æ¨¡å¼ï¼šå°†è¦†ç›–ç°æœ‰çš„å›¾ç‰‡é…ç½®")
        print()
    
    # æ‰§è¡Œæ‰¹é‡æ›´æ–°
    results = updater.batch_update_articles(force_update=force_update)
    
    if results.get('success'):
        # ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š
        report = updater.generate_report(results)
        
        # ä¿å­˜æŠ¥å‘Š
        report_file = Path("data/image_update_report.md")
        report_file.write_text(report, encoding='utf-8')
        
        print(f"\nğŸ“‹ è¯¦ç»†æŠ¥å‘Šå·²ä¿å­˜: {report_file}")
        print("\nğŸ¯ ä¸‹ä¸€æ­¥å»ºè®®:")
        print("   1. è¿è¡Œ hugo server é¢„è§ˆæ•ˆæœ")
        print("   2. æ£€æŸ¥å›¾ç‰‡æ˜¾ç¤ºæ˜¯å¦æ­£å¸¸")
        print("   3. å¦‚æœ‰éœ€è¦ï¼Œå¯è¿è¡Œ --force å¼ºåˆ¶æ›´æ–°")
        print("   4. å‡†å¤‡ç”³è¯· Google AdSense!")
    else:
        print(f"âŒ æ‰¹é‡æ›´æ–°å¤±è´¥: {results.get('error', 'æœªçŸ¥é”™è¯¯')}")
        sys.exit(1)

if __name__ == "__main__":
    main()

# === v2: write-back helper for front-matter (YAML) ===
import re
def apply_images_front_matter(md_text: str, assignment: dict):
    featured = assignment.get('hero',{}).get('src')
    if featured:
        md_text = re.sub(r'(?m)^featured_image:.*$', f'featured_image: {featured}', md_text)
    imgs = [featured] + [i.get('src') for i in assignment.get('inline',[]) if i.get('src')]
    imgs = [i for i in imgs if i]
    if imgs:
        block = "images:\n" + "\n".join([f"  - {u}" for u in imgs])
        if "images:" in md_text:
            md_text = re.sub(r'(?s)images:\n.*?(\n\w|\Z)', block + "\n", md_text)
        else:
            md_text = md_text.replace('---\n', f'---\n{block}\n', 1)
    return md_text
