#!/usr/bin/env python3
"""
Product Images Setup Script
è·å–å’Œè®¾ç½®æ™ºèƒ½å®¶å±…äº§å“å›¾ç‰‡ï¼Œç”¨äºGoogle AdSenseç”³è¯·å‡†å¤‡
"""

import os
import sys
import requests
from PIL import Image
import codecs
from pathlib import Path

# è§£å†³Windowsç¼–ç é—®é¢˜
if sys.platform == "win32":
    sys.stdout = codecs.getwriter("utf-8")(sys.stdout.detach())

def create_image_directories():
    """åˆ›å»ºå¿…è¦çš„å›¾ç‰‡ç›®å½•"""
    directories = [
        "static/images/products",
        "static/images/products/smart-plugs",
        "static/images/products/smart-bulbs", 
        "static/images/products/smart-thermostats",
        "static/images/products/smart-security",
        "static/images/scenes"
    ]
    
    for directory in directories:
        Path(directory).mkdir(parents=True, exist_ok=True)
        print(f"âœ… Created directory: {directory}")

def create_placeholder_images():
    """åˆ›å»ºé«˜è´¨é‡å ä½ç¬¦å›¾ç‰‡ï¼Œç¬¦åˆAdSenseè¦æ±‚"""
    
    # äº§å“å›¾ç‰‡é…ç½®
    products = {
        "smart-plugs": {
            "amazon-smart-plug": "Amazon Smart Plug - Voice Control with Alexa",
            "tp-link-kasa": "TP-Link Kasa Smart Plug - WiFi Connected",
            "govee-smart-plug": "Govee Smart Plug - Energy Monitoring"
        },
        "smart-bulbs": {
            "philips-hue-white": "Philips Hue White LED Smart Bulb",
            "lifx-color": "LIFX Color Changing Smart Bulb"
        },
        "smart-thermostats": {
            "google-nest": "Google Nest Learning Thermostat",
            "ecobee-smart": "Ecobee SmartThermostat with Voice Control"
        }
    }
    
    # åˆ›å»ºæ ‡å‡†å°ºå¯¸çš„å›¾ç‰‡ (400x300px, AdSenseæ¨èå°ºå¯¸)
    img_width, img_height = 400, 300
    
    for category, items in products.items():
        for product_key, product_name in items.items():
            # åˆ›å»ºç®€å•çš„äº§å“å ä½ç¬¦å›¾ç‰‡
            img = Image.new('RGB', (img_width, img_height), color='white')
            
            # å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ›´å¤šçš„å›¾ç‰‡å¤„ç†ï¼Œæ¯”å¦‚æ·»åŠ æ–‡å­—ã€è¾¹æ¡†ç­‰
            # ä½†ç›®å‰å…ˆåˆ›å»ºåŸºç¡€ç‰ˆæœ¬
            
            filepath = f"static/images/products/{category}/{product_key}.jpg"
            img.save(filepath, 'JPEG', quality=85, optimize=True)
            print(f"âœ… Created image: {filepath}")

def create_default_images():
    """åˆ›å»ºé»˜è®¤å›¾ç‰‡æ–‡ä»¶"""
    # é»˜è®¤æ–‡ç« å›¾ç‰‡ (åœ¨æ¨¡æ¿ä¸­å¼•ç”¨)
    default_img = Image.new('RGB', (800, 600), color='#f8fafc')
    default_img.save('static/images/default-article.jpg', 'JPEG', quality=85, optimize=True)
    print("âœ… Created default article image")
    
    # ç½‘ç«™logoå ä½ç¬¦
    logo_img = Image.new('RGB', (200, 60), color='#3b82f6')
    logo_img.save('static/images/logo.png', 'PNG', optimize=True)
    print("âœ… Created logo placeholder")

def update_image_references():
    """æ›´æ–°æ–‡ç« ç”Ÿæˆæ¨¡æ¿ä»¥åŒ…å«å›¾ç‰‡å¼•ç”¨"""
    print("\nğŸ“ å›¾ç‰‡é›†æˆè¯´æ˜:")
    print("=" * 50)
    print("1. å›¾ç‰‡å·²åˆ›å»ºåœ¨ static/images/products/ ç›®å½•")
    print("2. éœ€è¦æ‰‹åŠ¨æˆ–é€šè¿‡è„šæœ¬è·å–çœŸå®äº§å“å›¾ç‰‡æ›¿æ¢å ä½ç¬¦")
    print("3. å»ºè®®å›¾ç‰‡æ¥æº:")
    print("   - Amazonäº§å“å®˜æ–¹å›¾ç‰‡")
    print("   - åˆ¶é€ å•†å®˜ç½‘å›¾ç‰‡")
    print("   - å¼€æº/CCæˆæƒå›¾ç‰‡")
    print("4. å›¾ç‰‡è§„æ ¼: 400x300px, <100KB, JPEGæ ¼å¼")
    print("5. éœ€è¦ä¸ºæ¯å¼ å›¾ç‰‡æ·»åŠ åˆé€‚çš„altæ ‡ç­¾")

def create_image_sitemap():
    """åˆ›å»ºå›¾ç‰‡ç«™ç‚¹åœ°å›¾ï¼Œæœ‰åŠ©äºSEOå’ŒAdSense"""
    sitemap_content = '''<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"
        xmlns:image="http://www.google.com/schemas/sitemap-image/1.1">
  <url>
    <loc>https://ai-smarthomehub.com/smart-plugs/</loc>
    <image:image>
      <image:loc>https://ai-smarthomehub.com/images/products/smart-plugs/amazon-smart-plug.jpg</image:loc>
      <image:caption>Amazon Smart Plug with Alexa Voice Control</image:caption>
      <image:title>Best Smart Plug for Alexa 2025</image:title>
    </image:image>
  </url>
</urlset>'''
    
    with open('static/sitemap-images.xml', 'w', encoding='utf-8') as f:
        f.write(sitemap_content)
    print("âœ… Created image sitemap template")

def main():
    """ä¸»æ‰§è¡Œå‡½æ•°"""
    print("ğŸš€ å¼€å§‹è®¾ç½®äº§å“å›¾ç‰‡ä»¥æ”¯æŒGoogle AdSenseç”³è¯·")
    print("=" * 60)
    
    try:
        # åˆ›å»ºç›®å½•ç»“æ„
        create_image_directories()
        print()
        
        # åˆ›å»ºå ä½ç¬¦å›¾ç‰‡
        create_placeholder_images() 
        print()
        
        # åˆ›å»ºé»˜è®¤å›¾ç‰‡
        create_default_images()
        print()
        
        # åˆ›å»ºå›¾ç‰‡ç«™ç‚¹åœ°å›¾
        create_image_sitemap()
        print()
        
        # æ˜¾ç¤ºåç»­æ­¥éª¤
        update_image_references()
        
        print("\nğŸ‰ å›¾ç‰‡è®¾ç½®å®Œæˆï¼")
        print("ğŸ“‹ ä¸‹ä¸€æ­¥è¡ŒåŠ¨:")
        print("1. ç”¨çœŸå®äº§å“å›¾ç‰‡æ›¿æ¢å ä½ç¬¦")
        print("2. æ›´æ–°æ–‡ç« æ¨¡æ¿åŒ…å«å›¾ç‰‡å¼•ç”¨") 
        print("3. æ·»åŠ å›¾ç‰‡altæ ‡ç­¾ä¼˜åŒ–SEO")
        print("4. æµ‹è¯•å›¾ç‰‡åŠ è½½å’Œæ˜¾ç¤ºæ•ˆæœ")
        print("5. æäº¤Google AdSenseç”³è¯·")
        
        return True
        
    except Exception as e:
        print(f"âŒ é”™è¯¯: {e}")
        return False

if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)

# === v2: enforce env policy for placeholders ===
import os
ENV = os.getenv('ENV','dev')
ALLOW_PLACEHOLDER = (ENV != 'prod')
