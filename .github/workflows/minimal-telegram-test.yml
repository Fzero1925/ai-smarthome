name: Minimal Telegram Test

on:
  push:
    paths:
      - 'TELEGRAM_TEST_NOW.txt'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  telegram-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python timezone dependency
        run: |
          python -m pip install --upgrade pip
          pip install pytz

      - name: Test Telegram Bot Connection
        run: |
          echo "🔧 Testing Telegram Bot Connection"
          echo "=================================="
          
          if [ -z "${{ secrets.TELEGRAM_BOT_TOKEN }}" ]; then
            echo "❌ TELEGRAM_BOT_TOKEN not set in secrets"
            exit 1
          fi
          
          if [ -z "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
            echo "❌ TELEGRAM_CHAT_ID not set in secrets"
            exit 1
          fi
          
          echo "✅ Environment variables found"

      - name: Test Bot API
        run: |
          echo "📡 Testing Telegram Bot API..."
          
          RESPONSE=$(curl -s "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/getMe")
          echo "API Response: $RESPONSE"
          
          if echo "$RESPONSE" | grep -q '"ok":true'; then
            echo "✅ Bot API connection successful"
          else
            echo "❌ Bot API connection failed"
            exit 1
          fi

      - name: Send Test Notification
        run: |
          echo "📤 Sending test notification..."
          
          # Get current time in China timezone using Python
          CHINA_TIME=$(python3 -c "
from datetime import datetime
import pytz
china_tz = pytz.timezone('Asia/Shanghai')
china_time = datetime.now(china_tz)
print(china_time.strftime('%m-%d %H:%M'))
")
          
          MESSAGE="🧪 *GitHub Actions Telegram测试* | $CHINA_TIME

*测试结果*: ✅ 连接成功

*系统信息*:
• GitHub Actions 运行正常
• Python时区处理正常
• Markdown格式支持正常  
• 中文显示正常

*工作流*: minimal-telegram-test.yml
*触发方式*: 文件更新测试

🌐 [网站地址](https://ai-smarthome.vercel.app/)

_🤖 Claude Code + GitHub Actions_"
          
          RESULT=$(curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=$MESSAGE" \
            -d "parse_mode=Markdown" \
            -d "disable_web_page_preview=true")
          
          echo "Send Result: $RESULT"
          
          if echo "$RESULT" | grep -q '"ok":true'; then
            echo "✅ Test notification sent successfully!"
          else
            echo "❌ Failed to send notification"
            echo "Error details: $RESULT"
            exit 1
          fi

      - name: Test Status Summary
        if: always()
        run: |
          echo "📋 Test Summary"
          echo "=============="
          echo "✅ Repository secrets configured"
          echo "✅ Bot API connection working" 
          echo "✅ Message sending successful"
          echo "✅ China timezone handling working"
          echo "✅ Markdown formatting working"
          echo ""
          echo "🎉 Telegram notification system is fully operational!"