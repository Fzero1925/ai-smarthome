name: Minimal Telegram Test

on:
  push:
    paths:
      - 'TELEGRAM_TEST_NOW.txt'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  telegram-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python timezone dependency
        run: |
          python -m pip install --upgrade pip
          pip install pytz

      - name: Test Telegram Bot Connection
        run: |
          echo "ğŸ”§ Testing Telegram Bot Connection"
          echo "=================================="
          
          if [ -z "${{ secrets.TELEGRAM_BOT_TOKEN }}" ]; then
            echo "âŒ TELEGRAM_BOT_TOKEN not set in secrets"
            exit 1
          fi
          
          if [ -z "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
            echo "âŒ TELEGRAM_CHAT_ID not set in secrets"
            exit 1
          fi
          
          echo "âœ… Environment variables found"

      - name: Test Bot API
        run: |
          echo "ğŸ“¡ Testing Telegram Bot API..."
          
          RESPONSE=$(curl -s "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/getMe")
          echo "API Response: $RESPONSE"
          
          if echo "$RESPONSE" | grep -q '"ok":true'; then
            echo "âœ… Bot API connection successful"
          else
            echo "âŒ Bot API connection failed"
            exit 1
          fi

      - name: Send Test Notification
        run: |
          echo "ğŸ“¤ Sending test notification..."
          
          # Get current time in China timezone using Python
          CHINA_TIME=$(python3 -c "
from datetime import datetime
import pytz
china_tz = pytz.timezone('Asia/Shanghai')
china_time = datetime.now(china_tz)
print(china_time.strftime('%m-%d %H:%M'))
")
          
          MESSAGE="ğŸ§ª *GitHub Actions Telegramæµ‹è¯•* | $CHINA_TIME

*æµ‹è¯•ç»“æœ*: âœ… è¿æ¥æˆåŠŸ

*ç³»ç»Ÿä¿¡æ¯*:
â€¢ GitHub Actions è¿è¡Œæ­£å¸¸
â€¢ Pythonæ—¶åŒºå¤„ç†æ­£å¸¸
â€¢ Markdownæ ¼å¼æ”¯æŒæ­£å¸¸  
â€¢ ä¸­æ–‡æ˜¾ç¤ºæ­£å¸¸

*å·¥ä½œæµ*: minimal-telegram-test.yml
*è§¦å‘æ–¹å¼*: æ–‡ä»¶æ›´æ–°æµ‹è¯•

ğŸŒ [ç½‘ç«™åœ°å€](https://ai-smarthome.vercel.app/)

_ğŸ¤– Claude Code + GitHub Actions_"
          
          RESULT=$(curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=$MESSAGE" \
            -d "parse_mode=Markdown" \
            -d "disable_web_page_preview=true")
          
          echo "Send Result: $RESULT"
          
          if echo "$RESULT" | grep -q '"ok":true'; then
            echo "âœ… Test notification sent successfully!"
          else
            echo "âŒ Failed to send notification"
            echo "Error details: $RESULT"
            exit 1
          fi

      - name: Test Status Summary
        if: always()
        run: |
          echo "ğŸ“‹ Test Summary"
          echo "=============="
          echo "âœ… Repository secrets configured"
          echo "âœ… Bot API connection working" 
          echo "âœ… Message sending successful"
          echo "âœ… China timezone handling working"
          echo "âœ… Markdown formatting working"
          echo ""
          echo "ğŸ‰ Telegram notification system is fully operational!"