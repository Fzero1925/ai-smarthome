name: Test Telegram Notification

on:
  workflow_dispatch:
    inputs:
      test_message:
        description: 'Test message to send'
        required: false
        default: 'Hello from GitHub Actions!'
        type: string

permissions:
  contents: read

jobs:
  test-telegram:
    runs-on: ubuntu-latest
    steps:
      - name: Test Telegram notification
        run: |
          if [ "${{ secrets.TELEGRAM_BOT_TOKEN }}" != "" ] && [ "${{ secrets.TELEGRAM_CHAT_ID }}" != "" ]; then
            echo "✅ Telegram credentials found"
            
            # Format China time
            CHINA_TIME=$(python3 -c "
from datetime import datetime
import pytz
china_tz = pytz.timezone('Asia/Shanghai')  
china_time = datetime.now(china_tz)
print(china_time.strftime('%m-%d %H:%M'))
")
            
            TEST_MESSAGE="${{ github.event.inputs.test_message || 'Hello from GitHub Actions!' }}"
            
            MESSAGE="🧪 *Telegram通知测试* | $CHINA_TIME

*测试消息*: $TEST_MESSAGE

*系统信息*:
✅ GitHub Actions 正常运行
✅ 环境变量配置正确  
✅ Python时区处理正常
✅ Markdown格式支持

*网站链接*: [ai-smarthome.vercel.app](https://ai-smarthome.vercel.app/)

_🤖 Claude Code 测试完成_"
            
            echo "📤 Sending test message to Telegram..."
            
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
              -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
              -d "text=$MESSAGE" \
              -d "parse_mode=Markdown" \
              -d "disable_web_page_preview=true"
            
            if [ $? -eq 0 ]; then
              echo "✅ Telegram notification sent successfully"
            else
              echo "❌ Failed to send Telegram notification" 
            fi
          else
            echo "❌ Telegram credentials not found in secrets"
            echo "Please set TELEGRAM_BOT_TOKEN and TELEGRAM_CHAT_ID in repository secrets"
          fi

      - name: Test bot info
        run: |
          if [ "${{ secrets.TELEGRAM_BOT_TOKEN }}" != "" ]; then
            echo "🔍 Testing bot connection..."
            
            RESPONSE=$(curl -s "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/getMe")
            
            echo "Bot API Response: $RESPONSE"
            
            # Check if response contains "ok":true
            if echo "$RESPONSE" | grep -q '"ok":true'; then
              BOT_NAME=$(echo "$RESPONSE" | grep -o '"first_name":"[^"]*"' | sed 's/"first_name":"\([^"]*\)"/\1/')
              echo "✅ Bot connection successful: $BOT_NAME"
            else
              echo "❌ Bot connection failed"
              echo "Response: $RESPONSE"
            fi
          fi