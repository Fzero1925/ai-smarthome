name: Realtime Trending Monitor & Content Generator

on:
  schedule:
    # æ¯30åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡çƒ­ç‚¹ï¼ˆæ¬§ç¾æ´»è·ƒæ—¶é—´ä¼˜åŒ–ï¼‰
    - cron: '*/30 6-22 * * *'  # UTC 6-22ç‚¹æ¯30åˆ†é’Ÿæ£€æŸ¥
  
  workflow_dispatch:
    inputs:
      force_analysis:
        description: 'å¼ºåˆ¶åˆ†æï¼ˆå¿½ç•¥æ—¶åŒºé™åˆ¶ï¼‰'
        required: false
        default: false
        type: boolean
      check_only:
        description: 'ä»…æ£€æŸ¥ä¸ç”Ÿæˆæ–‡ç« '
        required: false
        default: false
        type: boolean
      max_articles:
        description: 'æœ€å¤§æ–‡ç« ç”Ÿæˆæ•°'
        required: false
        default: '2'
        type: string

permissions:
  contents: write

jobs:
  trending-monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Setup environment
        run: |
          # åˆ›å»ºå¿…è¦çš„ç›®å½•
          mkdir -p data/realtime_trends
          mkdir -p data/generation_history
          mkdir -p data/trending_cache
          mkdir -p modules/trending
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          echo "TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}" >> $GITHUB_ENV
          echo "TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}" >> $GITHUB_ENV

      - name: Check trending topics and trigger generation
        id: trending_check
        run: |
          echo "ğŸ”¥ å¼€å§‹å®æ—¶çƒ­ç‚¹æ£€æŸ¥..."
          
          # è®¾ç½®å‚æ•°
          FORCE_ANALYSIS="${{ github.event.inputs.force_analysis || 'false' }}"
          CHECK_ONLY="${{ github.event.inputs.check_only || 'false' }}"
          MAX_ARTICLES="${{ github.event.inputs.max_articles || '2' }}"
          
          # æ„å»ºå‚æ•°
          ARGS=""
          if [ "$FORCE_ANALYSIS" = "true" ]; then
            ARGS="$ARGS --force-analysis"
          fi
          if [ "$CHECK_ONLY" = "true" ]; then
            ARGS="$ARGS --check-only"
          fi
          
          # æ‰§è¡Œçƒ­ç‚¹åˆ†æå’Œè§¦å‘æ£€æŸ¥
          python scripts/realtime_workflow.py $ARGS --max-articles $MAX_ARTICLES

      - name: Commit new articles if generated
        if: steps.trending_check.outputs.has_new_content == 'true'
        run: |
          echo "ğŸ“ æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ–‡ç« éœ€è¦æäº¤..."
          
          # é…ç½®Git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action - Realtime Trending"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ–‡ä»¶
          if [ -n "$(git status --porcelain content/articles/*.md 2>/dev/null)" ]; then
            echo "âœ… å‘ç°æ–°ç”Ÿæˆçš„æ–‡ç« ï¼Œæ­£åœ¨æäº¤..."
            
            git add content/articles/*.md
            git add data/realtime_trends/ 2>/dev/null || true
            git add data/generation_history/ 2>/dev/null || true
            
            current_time=$(date '+%Y-%m-%d %H:%M:%S UTC')
            articles_count="${{ steps.trending_check.outputs.generated_articles }}"
            
            git commit -m "âš¡ Realtime: Generated $articles_count trending articles - $current_time

ğŸ”¥ Triggered by realtime trending analysis
ğŸ“Š Articles generated: $articles_count
â° Generated at: $current_time

ğŸ¤– Generated with Claude Code AI Assistant
Co-Authored-By: Claude <noreply@anthropic.com>"
            
            echo "ğŸ“¤ æ¨é€åˆ°è¿œç¨‹ä»“åº“..."
            git push
            
            echo "âœ… æ–°æ–‡ç« å·²æˆåŠŸæäº¤å’Œæ¨é€"
          else
            echo "â„¹ï¸ æ²¡æœ‰å‘ç°æ–°æ–‡ç« æ–‡ä»¶"
          fi

      - name: Send comprehensive Telegram notification
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # æ£€æŸ¥Telegramé…ç½®
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "âš ï¸ Telegramé…ç½®ä¸å®Œæ•´ï¼Œè·³è¿‡é€šçŸ¥"
            exit 0
          fi
          
          # è¯»å–åˆ†æç»“æœ
          ACTION="${{ steps.trending_check.outputs.action }}"
          TRENDS_COUNT="${{ steps.trending_check.outputs.trends_analyzed }}"
          ARTICLES_COUNT="${{ steps.trending_check.outputs.generated_articles }}"
          
          # è·å–å½“å‰åŒ—äº¬æ—¶é—´
          BEIJING_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
          
          # æ„å»ºé€šçŸ¥æ¶ˆæ¯
          if [ "$ACTION" = "error" ]; then
            MESSAGE="âŒ <b>å®æ—¶çƒ­ç‚¹ç›‘æ§ - æ‰§è¡Œå¤±è´¥</b>

â° æ—¶é—´: $BEIJING_TIME
ğŸ’¥ çŠ¶æ€: ç³»ç»Ÿé”™è¯¯
ğŸ“‹ è¯¦æƒ…: è¯·æ£€æŸ¥å·¥ä½œæµæ—¥å¿—

ğŸ”„ ä¸‹æ¬¡æ£€æŸ¥: 30åˆ†é’Ÿå"
          
          elif [ "$ACTION" = "analysis_only" ]; then
            MESSAGE="ğŸ” <b>å®æ—¶çƒ­ç‚¹ç›‘æ§ - ä»…åˆ†ææ¨¡å¼</b>

â° æ—¶é—´: $BEIJING_TIME
ğŸ“Š åˆ†æè¯é¢˜: $TRENDS_COUNT ä¸ª
â„¹ï¸ æ¨¡å¼: ä»…åˆ†æï¼Œæœªç”Ÿæˆæ–‡ç« 

ğŸ”„ ä¸‹æ¬¡æ£€æŸ¥: 30åˆ†é’Ÿå"
          
          elif [ "$ARTICLES_COUNT" -gt 0 ]; then
            MESSAGE="ğŸ”¥ <b>å®æ—¶çƒ­ç‚¹è§¦å‘ - æ–‡ç« å·²ç”Ÿæˆï¼</b>

â° æ—¶é—´: $BEIJING_TIME
ğŸ“Š åˆ†æè¯é¢˜: $TRENDS_COUNT ä¸ª
âœ… ç”Ÿæˆæ–‡ç« : $ARTICLES_COUNT ç¯‡
ğŸ’° é¢„ä¼°æœˆæ”¶ç›Š: \$$(($ARTICLES_COUNT * 400))-\$$(($ARTICLES_COUNT * 800))

ğŸ¯ <b>è§¦å‘åŸå› </b>
â€¢ æ£€æµ‹åˆ°é«˜ä»·å€¼çƒ­ç‚¹è¯é¢˜
â€¢ æ»¡è¶³å•†ä¸šä»·å€¼å’Œç´§æ€¥åº¦é˜ˆå€¼
â€¢ è‡ªåŠ¨è§¦å‘å®æ—¶æ–‡ç« ç”Ÿæˆ

ğŸŒ ç½‘ç«™: https://ai-smarthomehub.com
ğŸ”„ ä¸‹æ¬¡æ£€æŸ¥: 30åˆ†é’Ÿå"
          
          else
            MESSAGE="ğŸ“Š <b>å®æ—¶çƒ­ç‚¹ç›‘æ§ - å¸¸è§„æ£€æŸ¥</b>

â° æ—¶é—´: $BEIJING_TIME  
ğŸ“ˆ åˆ†æè¯é¢˜: $TRENDS_COUNT ä¸ª
â³ ç”Ÿæˆæ–‡ç« : 0 ç¯‡ï¼ˆæ— ç¬¦åˆæ¡ä»¶çš„çƒ­ç‚¹ï¼‰

ğŸ’¡ <b>ç›‘æ§çŠ¶æ€</b>
â€¢ æŒç»­ç›‘æ§æ¬§ç¾æ—¶åŒºçƒ­ç‚¹è¶‹åŠ¿
â€¢ æ™ºèƒ½è¯„ä¼°å•†ä¸šä»·å€¼å’Œç«äº‰åº¦
â€¢ è‡ªåŠ¨è§¦å‘é«˜ä»·å€¼å†…å®¹ç”Ÿæˆ

ğŸ”„ ä¸‹æ¬¡æ£€æŸ¥: 30åˆ†é’Ÿå"
          fi
          
          # å‘é€Telegramé€šçŸ¥
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
               -H "Content-Type: application/json" \
               -d "{
                 \"chat_id\": \"$TELEGRAM_CHAT_ID\",
                 \"text\": \"$MESSAGE\",
                 \"parse_mode\": \"HTML\",
                 \"disable_web_page_preview\": true
               }" > /dev/null
          
          echo "ğŸ“± Telegramé€šçŸ¥å·²å‘é€"

      - name: Update monitoring statistics
        if: always()
        run: |
          # æ›´æ–°ç›‘æ§ç»Ÿè®¡
          echo "ğŸ“Š æ›´æ–°ç›‘æ§ç»Ÿè®¡æ•°æ®..."
          
          STATS_FILE="data/monitoring_stats.json"
          CURRENT_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          # åˆ›å»ºæˆ–æ›´æ–°ç»Ÿè®¡æ–‡ä»¶
          python -c "
import json
import os
from datetime import datetime

stats_file = '$STATS_FILE'
current_time = '$CURRENT_TIME'
action = '${{ steps.trending_check.outputs.action }}'
trends_count = int('${{ steps.trending_check.outputs.trends_analyzed }}' or '0')
articles_count = int('${{ steps.trending_check.outputs.generated_articles }}' or '0')

# è¯»å–ç°æœ‰ç»Ÿè®¡
if os.path.exists(stats_file):
    with open(stats_file, 'r', encoding='utf-8') as f:
        stats = json.load(f)
else:
    stats = {
        'total_checks': 0,
        'total_articles_generated': 0,
        'last_successful_generation': None,
        'daily_stats': {},
        'recent_checks': []
    }

# æ›´æ–°ç»Ÿè®¡
stats['total_checks'] += 1
stats['total_articles_generated'] += articles_count
stats['last_check'] = current_time

if articles_count > 0:
    stats['last_successful_generation'] = current_time

# æ›´æ–°æ¯æ—¥ç»Ÿè®¡
date_key = current_time[:10]
if date_key not in stats['daily_stats']:
    stats['daily_stats'][date_key] = {'checks': 0, 'articles': 0}

stats['daily_stats'][date_key]['checks'] += 1
stats['daily_stats'][date_key]['articles'] += articles_count

# è®°å½•æœ€è¿‘æ£€æŸ¥
check_record = {
    'time': current_time,
    'action': action,
    'trends_analyzed': trends_count,
    'articles_generated': articles_count
}

stats['recent_checks'].append(check_record)

# ä¿æŒæœ€è¿‘50æ¡è®°å½•
if len(stats['recent_checks']) > 50:
    stats['recent_checks'] = stats['recent_checks'][-50:]

# ä¿å­˜ç»Ÿè®¡
os.makedirs(os.path.dirname(stats_file), exist_ok=True)
with open(stats_file, 'w', encoding='utf-8') as f:
    json.dump(stats, f, indent=2, ensure_ascii=False)

print(f'âœ… ç›‘æ§ç»Ÿè®¡å·²æ›´æ–°')
print(f'ğŸ“ˆ æ€»æ£€æŸ¥æ¬¡æ•°: {stats[\"total_checks\"]}')
print(f'ğŸ“ æ€»ç”Ÿæˆæ–‡ç« : {stats[\"total_articles_generated\"]}')
"
          
          echo "âœ… ç›‘æ§ç»Ÿè®¡æ›´æ–°å®Œæˆ"