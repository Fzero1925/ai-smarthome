{{/* Dynamic Explore Dropdown - 动态分类导航下拉菜单 */}}
{{/* 基于new-website.md建议的Priority+导航模式实现 */}}

{{/* 动态汇总分类并排序 */}}
{{ $terms := slice }}
{{ range $name, $tax := .Site.Taxonomies.categories }}
  {{ $terms = $terms | append (dict "name" $name "slug" ($name | urlize) "count" (len $tax.Pages)) }}
{{ end }}
{{ $terms = where (sort $terms "count" "desc") ".count" "gt" 0 }}

<div class="nav-explore" data-nav-explore>
  <button class="nav-explore__button"
          aria-haspopup="true"
          aria-expanded="false"
          aria-controls="explore-menu"
          data-explore-trigger>
    <span class="nav-explore__text">Explore</span>
    <svg class="nav-explore__icon" aria-hidden="true" viewBox="0 0 20 20" width="16" height="16">
      <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
    </svg>
  </button>

  <div id="explore-menu"
       class="nav-explore__menu"
       role="menu"
       aria-labelledby="explore-menu-title"
       hidden
       data-explore-menu>

    <div class="nav-explore__header">
      <h3 id="explore-menu-title" class="nav-explore__title">
        <i class="fa fa-compass"></i> Explore Categories
      </h3>
      <p class="nav-explore__subtitle">Browse by device type and smart home topics</p>
    </div>

    <div class="nav-explore__grid">
      {{ range first 12 $terms }}
      <a role="menuitem"
         class="nav-explore__item"
         href="{{ "/categories/" | relURL }}{{ .slug }}/"
         data-category="{{ .slug }}">
        <div class="nav-explore__item-icon">
          <i class="{{ partial "category-image.html" (dict "slug" .slug "type" "icon") }}"></i>
        </div>
        <div class="nav-explore__item-content">
          <span class="nav-explore__item-name">{{ .name | title }}</span>
          <span class="nav-explore__item-count">{{ .count }} {{ if eq .count 1 }}article{{ else }}articles{{ end }}</span>
        </div>
      </a>
      {{ end }}
    </div>

    <div class="nav-explore__footer">
      <a role="menuitem"
         class="nav-explore__view-all"
         href="{{ "/categories/" | relURL }}">
        <i class="fa fa-th-large"></i> View All Categories
      </a>
    </div>
  </div>
</div>

<style>
/* Explore Navigation Dropdown Styles */
.nav-explore {
  position: relative;
  display: inline-block;
}

.nav-explore__button {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  background: none;
  border: none;
  color: #495057;
  font-weight: 500;
  font-size: 1rem;
  cursor: pointer;
  border-radius: 6px;
  transition: all 0.3s ease;
  text-decoration: none;
}

.nav-explore__button:hover {
  color: #007bff;
  background-color: #f8f9fa;
}

.nav-explore__button:focus {
  outline: 2px solid #007bff;
  outline-offset: 2px;
}

.nav-explore__button[aria-expanded="true"] {
  color: #007bff;
  background-color: #f8f9fa;
}

.nav-explore__button[aria-expanded="true"] .nav-explore__icon {
  transform: rotate(180deg);
}

.nav-explore__icon {
  transition: transform 0.3s ease;
  fill: currentColor;
}

.nav-explore__menu {
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  background: white;
  border: 1px solid #e9ecef;
  border-radius: 12px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.12);
  min-width: 480px;
  max-width: 600px;
  z-index: 1000;
  padding: 1.5rem;
  margin-top: 0.5rem;
}

.nav-explore__menu[hidden] {
  display: none;
}

.nav-explore__header {
  margin-bottom: 1.5rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid #e9ecef;
}

.nav-explore__title {
  margin: 0 0 0.5rem 0;
  font-size: 1.25rem;
  color: #2c3e50;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.nav-explore__subtitle {
  margin: 0;
  font-size: 0.9rem;
  color: #6c757d;
  line-height: 1.4;
}

.nav-explore__grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 0.75rem;
  margin-bottom: 1.5rem;
}

.nav-explore__item {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.75rem;
  border-radius: 8px;
  text-decoration: none;
  color: inherit;
  transition: all 0.3s ease;
  border: 1px solid transparent;
}

.nav-explore__item:hover {
  background-color: #f8f9fa;
  border-color: #e9ecef;
  text-decoration: none;
  color: #007bff;
  transform: translateY(-1px);
}

.nav-explore__item:focus {
  outline: 2px solid #007bff;
  outline-offset: 2px;
  background-color: #f8f9fa;
}

.nav-explore__item-icon {
  width: 32px;
  height: 32px;
  background: #f8f9fa;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1rem;
  color: #6c757d;
  transition: all 0.3s ease;
}

.nav-explore__item:hover .nav-explore__item-icon {
  background: #007bff;
  color: white;
}

.nav-explore__item-content {
  flex: 1;
  min-width: 0;
}

.nav-explore__item-name {
  display: block;
  font-weight: 500;
  font-size: 0.9rem;
  margin-bottom: 0.25rem;
  color: #2c3e50;
}

.nav-explore__item-count {
  display: block;
  font-size: 0.8rem;
  color: #6c757d;
}

.nav-explore__footer {
  padding-top: 1rem;
  border-top: 1px solid #e9ecef;
  text-align: center;
}

.nav-explore__view-all {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1.5rem;
  background: #007bff;
  color: white;
  text-decoration: none;
  border-radius: 6px;
  font-weight: 500;
  transition: all 0.3s ease;
}

.nav-explore__view-all:hover {
  background: #0056b3;
  text-decoration: none;
  color: white;
  transform: translateY(-1px);
}

.nav-explore__view-all:focus {
  outline: 2px solid #ffffff;
  outline-offset: 2px;
}

/* Responsive Design */
@media (max-width: 768px) {
  .nav-explore__menu {
    left: 0;
    right: 0;
    transform: none;
    min-width: auto;
    max-width: none;
    margin: 0.5rem;
    width: calc(100vw - 1rem);
  }

  .nav-explore__grid {
    grid-template-columns: 1fr;
  }

  .nav-explore__item {
    padding: 1rem;
  }
}

@media (max-width: 480px) {
  .nav-explore__menu {
    padding: 1rem;
  }

  .nav-explore__button {
    padding: 0.5rem 0.75rem;
    font-size: 0.9rem;
  }
}

/* Animation for menu open/close */
.nav-explore__menu {
  animation: slideIn 0.2s ease;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateX(-50%) translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }
}

@media (max-width: 768px) {
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const exploreContainer = document.querySelector('[data-nav-explore]');
  if (!exploreContainer) return;

  const button = exploreContainer.querySelector('[data-explore-trigger]');
  const menu = exploreContainer.querySelector('[data-explore-menu]');

  if (!button || !menu) return;

  // Toggle menu visibility
  function toggleMenu(show) {
    const isOpen = show !== undefined ? show : button.getAttribute('aria-expanded') !== 'true';

    button.setAttribute('aria-expanded', String(isOpen));
    menu.hidden = !isOpen;

    if (isOpen) {
      // Focus first menu item for keyboard navigation
      const firstItem = menu.querySelector('a[role="menuitem"]');
      if (firstItem) {
        setTimeout(() => firstItem.focus(), 100);
      }
    }
  }

  // Button click handler
  button.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    toggleMenu();
  });

  // Close menu when clicking outside
  document.addEventListener('click', function(e) {
    if (!exploreContainer.contains(e.target)) {
      toggleMenu(false);
    }
  });

  // Keyboard navigation
  document.addEventListener('keydown', function(e) {
    if (button.getAttribute('aria-expanded') === 'true') {
      if (e.key === 'Escape') {
        e.preventDefault();
        toggleMenu(false);
        button.focus();
      }
    }
  });

  // Enhanced keyboard navigation within menu
  menu.addEventListener('keydown', function(e) {
    const menuItems = Array.from(menu.querySelectorAll('a[role="menuitem"]'));
    const currentIndex = menuItems.indexOf(document.activeElement);

    let nextIndex = currentIndex;

    switch (e.key) {
      case 'ArrowDown':
        e.preventDefault();
        nextIndex = currentIndex < menuItems.length - 1 ? currentIndex + 1 : 0;
        break;
      case 'ArrowUp':
        e.preventDefault();
        nextIndex = currentIndex > 0 ? currentIndex - 1 : menuItems.length - 1;
        break;
      case 'Home':
        e.preventDefault();
        nextIndex = 0;
        break;
      case 'End':
        e.preventDefault();
        nextIndex = menuItems.length - 1;
        break;
      case 'Tab':
        if (!e.shiftKey && currentIndex === menuItems.length - 1) {
          // Close menu when tabbing out of last item
          toggleMenu(false);
        }
        return;
    }

    if (nextIndex !== currentIndex && menuItems[nextIndex]) {
      menuItems[nextIndex].focus();
    }
  });

  // Analytics tracking (optional)
  menu.addEventListener('click', function(e) {
    const link = e.target.closest('a[data-category]');
    if (link) {
      const category = link.dataset.category;
      // Track category exploration
      if (typeof gtag !== 'undefined') {
        gtag('event', 'explore_category', {
          'category_name': category,
          'source': 'explore_dropdown'
        });
      }
    }
  });
});
</script>