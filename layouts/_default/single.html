{{ define "main" }}
<!-- SEO Enhancements: Structured data is now handled in baseof.html for better performance -->

{{ if .Params.product_review }}
<!-- Product Review Structured Data -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Review",
  "itemReviewed": {
    "@type": "Product",
    "name": "{{ .Params.product_review.name }}",
    "image": "{{ .Params.product_review.image | default .Params.featured_image }}",
    "description": "{{ .Params.product_review.description }}",
    "brand": {
      "@type": "Brand",
      "name": "{{ .Params.product_review.brand }}"
    },
    {{ if .Params.product_review.model }}
    "model": "{{ .Params.product_review.model }}",
    {{ end }}
    {{ if .Params.product_review.sku }}
    "sku": "{{ .Params.product_review.sku }}",
    {{ end }}
    "aggregateRating": {
      "@type": "AggregateRating",
      "ratingValue": {{ .Params.product_review.rating }},
      "ratingCount": {{ .Params.product_review.review_count | default 25 }},
      "bestRating": 5,
      "worstRating": 1
    },
    {{ if .Params.product_review.price }}
    "offers": {
      "@type": "Offer",
      "price": "{{ .Params.product_review.price }}",
      "priceCurrency": "USD",
      "availability": "https://schema.org/InStock",
      "seller": {
        "@type": "Organization",
        "name": "Amazon"
      }
    }
    {{ end }}
  },
  "reviewRating": {
    "@type": "Rating",
    "ratingValue": {{ .Params.product_review.rating }},
    "bestRating": 5,
    "worstRating": 1
  },
  "name": "{{ .Title }}",
  "author": {
    "@type": "Person",
    "name": "{{ if .Params.author }}{{ .Params.author }}{{ else }}{{ .Site.Params.author }}{{ end }}"
  },
  "reviewBody": "{{ .Summary | truncate 300 }}",
  "datePublished": "{{ .Date.Format "2006-01-02T15:04:05Z07:00" }}"
}
</script>
{{ end }}

{{ if .Params.faq }}
<!-- FAQ Structured Data -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": [
    {{ range $index, $item := .Params.faq }}
    {{ if $index }},{{ end }}
    {
      "@type": "Question",
      "name": "{{ $item.question }}",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "{{ $item.answer }}"
      }
    }
    {{ end }}
  ]
}
</script>
{{ end }}

<!-- Breadcrumb Structured Data -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": "{{ .Site.BaseURL }}"
    }
    {{ if .Params.categories }}
      {{ range $index, $category := (first 1 .Params.categories) }}
      ,{
        "@type": "ListItem",
        "position": 2,
        "name": "{{ $category | title }}",
        "item": "{{ $.Site.BaseURL }}categories/{{ $category | urlize }}/"
      }
      {{ end }}
      ,{
        "@type": "ListItem",
        "position": 3,
        "name": "{{ .Title }}",
        "item": "{{ .Permalink }}"
      }
    {{ else }}
    ,{
      "@type": "ListItem",
      "position": 2,
      "name": "{{ .Title }}",
      "item": "{{ .Permalink }}"
    }
    {{ end }}
  ]
}
</script>

<article class="article">
  <div class="container">
    <!-- Breadcrumb Navigation -->
    <nav class="breadcrumb" aria-label="breadcrumb">
      <ol class="breadcrumb-list">
        <li class="breadcrumb-item">
          <a href="{{ .Site.BaseURL }}">
            <i class="fa fa-home"></i> Home
          </a>
        </li>
        {{ if .Params.categories }}
          {{ range first 1 .Params.categories }}
          <li class="breadcrumb-item">
            <a href="{{ "/categories/" | relLangURL }}{{ . | urlize }}">
              {{ . | title }}
            </a>
          </li>
          {{ end }}
        {{ end }}
        <li class="breadcrumb-item active" aria-current="page">
          {{ .Title | truncate 50 }}
        </li>
      </ol>
    </nav>

    <!-- Enhanced Article Header with Core Web Vitals Optimization -->
    <header class="article-header">
      <h1 class="article-title">{{ .Title }}</h1>
      
      <!-- Featured Image with Core Web Vitals Optimization -->
      {{ if .Params.featured_image }}
      <div class="featured-image-container">
        <img src="{{ .Params.featured_image }}" 
             alt="{{ if .Params.featured_image_alt }}{{ .Params.featured_image_alt }}{{ else }}{{ .Title }}{{ end }}"
             class="featured-image"
             loading="eager"
             decoding="async"
             width="1200"
             height="630"
             fetchpriority="high">
      </div>
      {{ end }}
      
      <div class="article-meta">
        <time class="published" datetime="{{ .Date.Format "2006-01-02T15:04:05Z07:00" }}">
          <i class="fa fa-calendar"></i> {{ .Date.Format "January 2, 2006" }}
        </time>
        
        <!-- Reading Time Calculation -->
        {{ if .Site.Params.content.article.reading_time }}
        <span class="reading-time">
          <i class="fa fa-clock"></i> {{ math.Ceil (div (countwords .Content) 200.0) }} min read
        </span>
        {{ end }}
        
        <!-- Word Count -->
        {{ if .Site.Params.content.article.word_count }}
        <span class="word-count">
          <i class="fa fa-file-text"></i> {{ .WordCount }} words
        </span>
        {{ end }}
        
        <!-- Last Modified -->
        {{ if and .Site.Params.content.article.last_modified (ne .Date .Lastmod) }}
        <time class="modified" datetime="{{ .Lastmod.Format "2006-01-02T15:04:05Z07:00" }}">
          <i class="fa fa-edit"></i> Updated {{ .Lastmod.Format "January 2, 2006" }}
        </time>
        {{ end }}
        
        {{ if .Params.categories }}
        <span class="categories">
          <i class="fa fa-folder"></i>
          {{ range .Params.categories }}
            <a href="{{ "/categories/" | relLangURL }}{{ . | urlize }}">{{ . }}</a>
          {{ end }}
        </span>
        {{ end }}
        {{ if .Params.tags }}
        <span class="tags">
          <i class="fa fa-tags"></i>
          {{ range .Params.tags }}
            <a href="{{ "/tags/" | relLangURL }}{{ . | urlize }}">#{{ . }}</a>
          {{ end }}
        </span>
        {{ end }}
        
        <!-- Review Rating Display -->
        {{ if .Params.review_rating }}
        <div class="review-rating">
          <i class="fa fa-star"></i> {{ .Params.review_rating }}/5
          {{ if .Params.review_count }}({{ .Params.review_count }} reviews){{ end }}
        </div>
        {{ end }}
      </div>
    </header>

    <!-- Top AdSense Slot -->
    {{ partial "adsense.html" . }}
    
    <!-- Enhanced Article Content with SEO and Performance Optimization -->
    <div class="article-content">
      <!-- Table of Contents (if enabled) -->
      {{ if .Site.Params.content.table_of_contents }}
      <div class="table-of-contents">
        <h3><i class="fa fa-list"></i> Table of Contents</h3>
        {{ .TableOfContents }}
      </div>
      {{ end }}
      
      <!-- Article Summary/Introduction -->
      {{ if .Summary }}
      <div class="article-summary">
        <strong>TL;DR:</strong> {{ .Summary | truncate 200 }}
      </div>
      {{ end }}
      
      <!-- Enhanced Content with Performance Optimization -->
      <div class="content-body">
        {{ .Content | replaceRE `<img([^>]+)src="([^"]+)"([^>]*)>` `<img$1src="$2" loading="lazy" decoding="async"$3>` | safeHTML }}
      </div>
      
      <!-- Content Quality Indicators -->
      {{ if .Site.Params.content.quality_indicators }}
      <div class="content-stats">
        <div class="stat-item">
          <i class="fa fa-clock"></i>
          <span>{{ math.Ceil (div (countwords .Content) 200.0) }} min read</span>
        </div>
        <div class="stat-item">
          <i class="fa fa-file-text"></i>
          <span>{{ .WordCount }} words</span>
        </div>
        {{ if .Params.review_rating }}
        <div class="stat-item">
          <i class="fa fa-star"></i>
          <span>{{ .Params.review_rating }}/5 rating</span>
        </div>
        {{ end }}
      </div>
      {{ end }}
    </div>
    
    <!-- Middle AdSense Slot -->
    {{ partial "adsense.html" . }}
    
    <!-- Affiliate Product Recommendations -->
    {{ if .Params.featured_products }}
    <section class="featured-products">
      <h3><i class="fa fa-star"></i> Recommended Products</h3>
      {{ partial "affiliate.html" . }}
    </section>
    {{ end }}
    
    <!-- FAQ Section -->
    {{ if .Params.faq }}
    <section class="faq-section">
      <h3><i class="fa fa-question-circle"></i> Frequently Asked Questions</h3>
      {{ range .Params.faq }}
      <div class="faq-item">
        <h4>{{ .question }}</h4>
        <p>{{ .answer | markdownify }}</p>
      </div>
      {{ end }}
    </section>
    {{ end }}
    
    <!-- Bottom AdSense Slot -->
    {{ partial "adsense.html" . }}
    
    <!-- Related Articles -->
    {{ $related := .Site.RegularPages.Related . | first 4 }}
    {{ if $related }}
    <section class="related-articles">
      <h3><i class="fa fa-lightbulb"></i> Related Articles</h3>
      <div class="related-grid">
        {{ range $related }}
        <article class="related-item">
          <a href="{{ .Permalink }}">
            <h4>{{ .Title }}</h4>
            <p>{{ .Summary | truncate 100 }}</p>
          </a>
        </article>
        {{ end }}
      </div>
    </section>
    {{ end }}
    
    <!-- Internal Linking Enhancement -->
    {{ partial "internal_links.html" . }}
  </div>
</article>

<!-- Breadcrumb Styling -->
<style>
.breadcrumb {
  margin-bottom: 1.5rem;
  padding: 0.75rem 0;
  border-bottom: 1px solid #e5e7eb;
}

.breadcrumb-list {
  display: flex;
  flex-wrap: wrap;
  list-style: none;
  margin: 0;
  padding: 0;
  font-size: 0.9rem;
}

.breadcrumb-item {
  display: flex;
  align-items: center;
}

.breadcrumb-item + .breadcrumb-item::before {
  content: "â€º";
  color: #6b7280;
  font-weight: bold;
  margin: 0 0.5rem;
}

.breadcrumb-item a {
  color: #3b82f6;
  text-decoration: none;
  transition: color 0.3s ease;
}

.breadcrumb-item a:hover {
  color: #1d4ed8;
  text-decoration: underline;
}

.breadcrumb-item.active {
  color: #4b5563;
  font-weight: 500;
}

.breadcrumb-item i {
  margin-right: 0.25rem;
  font-size: 0.8rem;
}

@media (max-width: 768px) {
  .breadcrumb-list {
    font-size: 0.8rem;
  }
  
  .breadcrumb-item + .breadcrumb-item::before {
    margin: 0 0.3rem;
  }
}
</style>

{{ end }}